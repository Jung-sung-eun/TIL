## 2021. 11. 23

### 조인 (JOIN)

```mysql
SELECT 열 리스트
FROM 테이블명1
		 INNER JOIN 테이블명2
		 ON 조인 조건 (기본키 = 외래키);
```

- 여러 개의 테이블을 결합하여 조건에 맞는 행 검색

#### 조인의 종류

- 내부 조인 (INNER JOIN)  → 가장 많이 사용
- 공통되는 열이 있을 때  (기본키 = 외래키)
- 공통 열의 속성 값이 동일한 튜플만 반환

#### 외부 조인 (OUTER JOIN)

- 공통되는 열이 없을 때
- 공통되는 열(속성)을 매개로 하는 데이터가 없더라도 버리지 않고 연산의 결과를 테이블에 표시
- 값이 없는 대응 속성에 NULL 값을 채워서 반환
- 좌측 외부 조인 (LEFT OUTER JOIN)
  - 좌측 테이블의 데이터 유지
- 우측 외부 조인 (RIGHT OUTER JOIN)
  - 우측 테이블의 데이터 유지
- 완전 외부 조인 (FULL OUTER JOIN)
  - 두 테이블의 모든 정보 유지



### 서브 쿼리 (Subquery)

- 하위 질의 또는 부속 질의 라고도 함
- 하나의 SQL 문 안에 다른 SQL 문이 중첩되어 있는 형식
- 질의를 1차 수행한 다음, 반환값을 다음 질의에 포함시켜 사용
- 다른 테이블에서 결과로 가져온 데이터로 현재 테이블에 있는 정보를 찾거나 가공할 때 사용



#### 서브쿼리 유형

| 명칭            | 사용위치 | 영문 및 동의어                                    | 설명                                      |
| :-------------- | :------- | :------------------------------------------------ | :---------------------------------------- |
| 스칼라 서브쿼리 | SELECT절 | Scalar Subquery / 열이름 위치 표기                | 단일 열 반환                              |
| 인라인 뷰       | FROM절   | Inline View Table Subquery / 테이블명 위치에 표기 | 결과를 뷰(View)형태로 반환 (가상테이블)   |
| 중첩 서브쿼리   | WHERE절  | Nested Subquery Predicate Subquery                | 술어와 같이 사용 / 결과를 한정시키기 위해 |



#### 조인 VS 서브쿼리

- 조인

  - 여러 테이블 데이터를 모두 합쳐서 연산
  - 카티전곱 후 조건에 맞는 행을 검색
  - 카티전곱 연산 + SELECT 연산
    - 예:  테이블1 (15행), 테이블2(3행) 15 X 3 = 45행 반환

- 서브쿼리

  - 필요한 데이터만 찾아서 제공
  - 테이블1에서 찾아서 그 결과로 테이블2에서 검색
  - 경우에 따라 조인보다 성능이 더 좋을 수도 있음
  - 대량의 데이터에서 서브 쿼리를 수행할 때 성능이 나쁠 수도 있음
  - 논란의 여지가 있음

- 서브쿼리의 구성 및 형식

  - 메인 쿼리와 서브 쿼리로 구성
  - 서브 쿼리에서 검색한 결과로 메인 쿼리 검색 수행

- 단일 행 서브쿼리

  - 서브쿼리 결과 같이 단일 행인 경우
  - (=) 연산자 사용

- 다중 행 서브쿼리

  - 서브쿼리 결과 같이 여러 행인 경우
  - IN, ANY, ALL, EXISTS 연산자 사용

- 서브쿼리 연산자

  - WHERE절에서 사용

- 비교 연산자

  - = : 단일행 반환
  - 서브쿼리 결과가 단일행에 대해 한 결과 다중 행 반환

  | 연산 | 연산자                          | 반환 행 |
  | :--: | ------------------------------- | :-----: |
  | 비교 | =, >, <, >=, <=, !=             |  단일   |
  | 집합 | IN, NOT IN                      |  다중   |
  | 존재 | EXISTS, NOT EXISTS              |  다중   |
  | 한정 | ALL (모두), ANY (최소 하나라도) |  다중   |

  - IN : 다중 행 반환인 경우에 사용 (단일 행 반환 시 사용해도 오류 없음)  / 서브쿼리 결과에 NULL값 포함되지 않음
  - = : 단일행 반환인 경우에 사용 (결과가 여러 행인 경우에 사용 시 오류 발생)
  - 결과 행을 잘 모르겠으면 IN 사용

- ALL / ANY : 관계 연산자 뒤에 위치

  - WHERE bsQty > ALL (...);

- ALL : 검색 조건이 서브 쿼리 결과의 모든 값에 만족하면 참이 되는 연산자

  - 조건 > ALL (서브 쿼리 결과)

- ANY : 검색 조건이 서브 쿼리 결과 중에서 하나 이상에 만족하면 참이 되는 연산자

  - 조건 > ANY (서브 쿼리 결과)



#### IN과 EXIST의 차이

- IN
  - 서브쿼리에서 조건에 해당되는 행의 열을 비교하여 값 확인
  - 서브쿼리의 결과 값을 메인 쿼리에 대입하여 조건 비교 후 결과 출력
  - IN쿼리 → 메인쿼리
- EXISTS
  - 서브쿼리에서 조건에 해당되는 행의 존재 여부만 확인 (TRUE/FALSE 반환)
  - 따라서 IN에 비해 성능 좋음
  - EXISTS 키워드 앞에 속성명, 수식 등 올 수 없음
  - WHERE절에 외래키 제약조건 지정
  - NULL값 포함 : NULL값도 결과에 포함



#### NOT EXISTS와 NOT IN 차이

- 대부분 NOT EXISTS와 NOT IN 결과 동일
- 공통되는 조인 속성의 값이 NULL인 경우 결과 다름
  - NOT EXISTS : NULL 값도 결과에 포함
  - NOT IN : NULL 값이 결과에 포함되지 않음



#### 스칼라 서브쿼리 (Scalar Subquery)

- SELECT절에서 사용
- SELECT절에 오는 것은 열이름 리스트
- 단일 열 반환결과 값을 단일 열의 스칼라 값으로 반환
- 스칼라 값이 들어 갈 수 있는 곳에서 사용 가능
- 일반적으로 SELECT문과 UPDATE SET문에서 사용 가능



#### 인라인 뷰 서브쿼리 (Inline View Subquery)

- FROM 절에서 사용
- 즉, 테이블명 대신 인라인 뷰 쿼리 결과 (가상 테이블:뷰) 사용
- 서브 쿼리 결과로 반환되는 데이터는 다중 행, 다중 열이어도 상관 없음
- 가상의 뷰 형태로 제공
- 개발 중에 뷰가 필요한 모든 경우에 뷰를 생성하면 관리할 양이 너무 많이 트랜잭션 관리나 성능 상의 문제가 발생할 수 있는 경우에 필요한 시점에서 필요한 뷰를 인라인 뷰로 생성해서 사용



### 테이블 복사

```mysql
CREATE TABLE 새 테이블 이름 AS
SELECT 열이름 리스트 FROM 원본 테이블 [WHERE절];
```

- 새 테이블로 전체 복사
- 새 테이블로 일부만 복사
- 기존 테이블로 데이터만 복사
- 다른 데이터베이스의 테이블 복사

❗️기본키 등 제약조건은 복사안 됨 / 복사 후 제약조건 설정해야 함❗️